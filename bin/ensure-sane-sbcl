#!/bin/bash
echo "Ensuring that a sane version of SBCL is available"

bad=

if ! which sbcl
then
    echo "No ‘sbcl’ executable found on PATH" >&2
    echo PATH=$PATH
    bad=none
else
    if sbcl --noinform \
         --no-userinit \
         --non-interactive \
         --eval '(unless (find :asdf3.1 *features*) (sb-ext:exit :code 1))' \
         --eval '(format t "~&ASDF version is ~a" (asdf:asdf-version))' \
         --eval '(unless (asdf::version<= "3.1" (asdf:asdf-version)) (sb-ext:exit :code 2))'
    then
        bad=asdf-old
        echo "ASDF is older than v3.1" >&2
    fi
fi

if [ "x$bad" = "x" ]
then
    echo "✓ SBCL seems OK"
    ln -sf $(which sbcl) bin/sbcl
    exit 0
else
    echo "✗ SBCL is not usable ($bad). Going to have to update." >&2
    mkdir -p src/lib/sbcl
    pushd src/lib/sbcl
    echo "Downloading SBCL source tree"
    curl -L --retry 10 -s https://sourceforge.net/projects/sbcl/files/latest/download?source=files > sbcl-latest.tar.bz2 || exit 9
    echo "Extracting source tree from archive"
    tar jxf sbcl-latest.tar.bz2 || exit 10
    rm sbcl-latest.tar.bz2 || exit 11

    if ! ( echo "PATH" | grep -q "$HOME/.local/bin" )
    then
        echo "~/.local/bin does not appear to be on PATH" >&2
    fi

    cd $(echo sbcl-1.*/)
    if ! [ -f install.sh ]
    then
        echo "Archive might not have extracted correctly. Can't find install.sh" >&2
        echo "Found myself in $(pwd)"
        ls -l
        exit 13
    fi

    if which sbcl
    then
        lisp=sbcl --no-userinit
    elif which lisp
    then
        # Hopefully it's CMUCL
        lisp=lisp -batch -noinit
    else
        echo "Can't find any compiler to use to bootstrap" >&2
        exit 15
    fi
    
    
    echo "Performing bootstrap build with «$lisp»"
    if ! sh make.sh --xc-host="$lisp"
    then
        echo "Unable to build" >&2
        exit 14
    fi

    root=$(cd ../../../build/sbcl; pwd)
    mkdir -p "$root"
    echo "Installing to $root"
    INSTALL_ROOT="$root" sh install.sh
    popd

    echo "Setting bin/sbcl"
    rm -f bin/sbcl
    echo '#!/bin/bash' > bin/sbcl
    echo 'SBCL_HOME="'$root'" "'$root'"/bin/sbcl "$@"' >> bin/sbcl
    chmod +x bin/sbcl
    
    echo " ✓ Done"
fi
